<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" />
    <title>Arkanoid</title>
</head>
<style>
    #mainWrapper {
        margin-left: "25px";
    }
    
    #gameWindow {
        cursor: none;
    }
</style>

<body>
    <div id="mainWrapper">
        <div id="test"></div>
        <audio id="bounce">
            <source src="./sounds/bounce.wav" type="audio/wav">
        </audio>
        <div>
            <span id="debug"></span>
            <h1>
                Arkanoid
            </h1>
            <div class="btn" id="startBtn">
                New Game
            </div>
        </div>
        <div style="display: inline-block;">
            <p style='display:inline'>
                Score :
            </p>
            <p id="score" style="display: inline;" width="80px">0</p>
        </div>
        <div id="gameWindow"></div>
    </div>
    <script>
        window.onload = function() {
            var windowWidth = 640;
            var windowHeight = 480;

            document.getElementById('gameWindow').innerHTML = '<canvas id="gameStage" width="' + windowWidth + '" height="' + windowHeight + '" style="border:1px solid #d3d3d3;"></canvas>';

            var canvas = document.getElementById('gameStage');
            var context = canvas.getContext("2d");
            var audioBounce = document.getElementById("bounce");

            var debug = function(text) {
                document.getElementById('debug').innerHTML = text;
            };

            var updateScore = function(score) {
                document.getElementById('score').innerHTML = score;
            };

            function Player(x, w, h, l, s) {
                this.posX = x;
                this.width = w;
                this.height = h;
                this.lives = l;
                this.score = s;

                this.renderPad = function() {
                    //c = document.getElementById("gameStage");
                    //ctx = c.getContext("2d");
                    context.fillStyle = "#732cdd";
                    context.fillRect(this.posX, windowHeight - this.height, this.width, this.height);
                };
            };

            function Box(x, y, w, h, d) {
                this.posX = x;
                this.posY = y;
                this.width = w;
                this.height = h;
                this.durability = d;

                this.renderBox = function() {
                    if (this.durability > 0) {
                        //c = document.getElementById("gameStage");
                        //ctx = c.getContext("2d");
                        context.fillStyle = "#2d68c6";
                        context.fillRect(this.posX, this.posY, this.width, this.height);
                    }
                };
            };

            function Ball(x, y, s, spdX, spdY) {
                this.posX = x;
                this.posY = y;
                this.size = s;
                this.speedX = spdX;
                this.defaultSpeedX = spdX;
                this.speedY = spdY;
                this.boxes = [];

                this.renderBall = function() {
                    //c = document.getElementById("gameStage");
                    //ctx = c.getContext("2d");
                    context.arc(this.posX, this.posY, this.size, 0, 2 * Math.PI);
                    context.fillStyle = "#da63ed";
                    context.fill();
                };

                this.moveBall = function() {
                    if (this.posX + this.speedX < windowWidth - this.size / 2 || this.posX + this.speedX > this.size / 2) {
                        this.posX = this.posX + this.speedX;
                    };
                    if (this.posY + this.speedY < windowHeight || this.posY + this.speedY > this.size / 2) {
                        this.posY = this.posY + this.speedY;
                    };
                };

            };

            function Game() {

                var game = this;

                this.running = false;

                this.init = function() {
                    this.ball = new Ball(80, 180, 6, 6, 9);
                    this.boxes = [];
                    this.player = new Player(windowWidth / 2 - 35, 90, 15, 3, 0);
                    this.score = 0;
                    this.running = true;

                    for (i = 0; i < 4; i++) {
                        for (j = 0; j < 8; j++)
                            this.boxes.push(new Box(j * windowWidth / 8 + 1, i * windowHeight / 16 + 1, windowWidth / 8 - 2, windowHeight / 16 - 2, 1));
                    };

                    this.execute();
                };

                this.clearScreen = function() {
                    //var c = document.getElementById("gameStage");
                    //var ctx = c.getContext("2d"); 
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.beginPath();
                };

                this.checkForCollision = function(ball) {
                    var ballCenterX = ball.posX - ball.size / 2;
                    var ballCenterY = ball.posY + ball.size / 2;
                    var playerCenterX = this.player.posX + this.player.width / 2;
                    if (ballCenterY >= windowHeight - this.player.height && (ballCenterX >= this.player.posX && ballCenterX <= this.player.posX + this.player.width)) {
                        ball.speedY = -1 * ball.speedY;

                        ball.speedX = 2 * ball.defaultSpeedX * (ballCenterX - playerCenterX) / (this.player.width / 2);
                        //////audioBounce.play();
                    }

                    //detecting wall collision
                    if (ball.posX <= ball.size / 2 || ball.posX >= windowWidth + ball.size / 2) {
                        ball.speedX = -1 * ball.speedX;
                        //////audioBounce.play();
                    }

                    if (ball.posY <= ball.size / 2) {
                        ball.speedY = -1 * ball.speedY;
                        //////audioBounce.play();
                    }

                    if (ball.posY + ball.size / 2 >= windowHeight) {
                        this.running = false;
                    }

                    //detecting box collision
                    this.boxes.forEach(function(box) {
                        if (box.durability > 0) {
                            //detecting horizontal collision
                            if ((ball.posY - ball.size / 2 <= box.posY + box.height && ball.posY >= box.posY) &&
                                (ball.posX - ball.size / 2 >= box.posX &&
                                    ball.posX + ball.size / 2 <= box.posX + box.width)) {
                                //console.log('collision 1', ball.posX, ball.posY);
                                box.durability = 0;
                                game.score = game.score + 1;
                                ball.speedY = -1 * ball.speedY;
                                //////audioBounce.play();
                            }

                            //detecting vertical collision
                            if ((ball.posX - ball.size / 2 <= box.posX + box.width && ball.posX - ball.size / 2 >= box.posX) &&
                                (ball.posY - ball.size / 2 >= box.posY &&
                                    ball.posY + ball.size / 2 <= box.posY + box.height)) {
                                //console.log('collision 3', ball.posX, ball.posY);
                                box.durability = 0;
                                game.score = game.score + 1;
                                ball.speedX = -1 * ball.speedX;
                                ////audioBounce.play();
                            }
                        };
                    });
                };

                this.execute = function() {

                    game.gameLoop = setInterval(function() {
                        if (game.running == false) {
                            alert('Game over ! Your final score is : ' + game.score);
                            clearInterval(game.gameLoop);
                        };
                        updateScore(game.score);
                        game.clearScreen();
                        game.ball.moveBall();
                        game.checkForCollision(game.ball);
                        game.player.renderPad();
                        game.ball.renderBall();
                        game.boxes.forEach(function(box) {
                            box.renderBox();
                        });
                    }, 1000 / 15);
                };
            };

            document.addEventListener("touchmove", function(e) {
                e.preventDefault();
                var touch = e.touches[0];
                //console.log(game.player.posX,'1');
                if (touch.clientX - game.player.width / 2 > 0 && touch.clientX + game.player.width / 2 < windowWidth) {
                    game.player.posX = touch.clientX - game.player.width / 2;
                }
            }, false);

            document.body.addEventListener("touchstart", function(e) {
                e.preventDefault();
            }, false);
            document.body.addEventListener("touchend", function(e) {
                e.preventDefault();
            }, false);

            canvas.addEventListener("mousemove", function(e) {
                var rect = canvas.getBoundingClientRect();
                var mousePosX = e.clientX - rect.left;

                if (mousePosX - game.player.width / 2 > 0 && mousePosX + game.player.width / 2 < windowWidth) {
                    game.player.posX = mousePosX - game.player.width / 2;
                }

            }, false);

            game = new Game();

            document.getElementById("startBtn").addEventListener('click', function(e) {
                game.init();
                console.log('clicked');
            });
            game.init();

        };
    </script>
</body>

</html>